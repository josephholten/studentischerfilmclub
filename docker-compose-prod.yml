version: '3'
services:
    ui:
        build:
            context: ui
            dockerfile: Dockerfile.prod 
        restart: on-failure:5
        networks:
            - traefik
        labels:
            # traefik config
           - "holten.publish=j"
           - "traefik.http.routers.ui.rule=Host(`studentischerfilmclub.de`)"
           - "traefik.http.routers.ui.tls.certResolver=letsencrypt"

    api:
        build:
            context: api
            dockerfile: Dockerfile.prod
        restart: on-failure:5
        networks:
            - traefik
        labels:
            # traefik config
           - "holten.publish=j"
           - "traefik.http.routers.api.rule=Host(`studentischerfilmclub.de`) && PathPrefix(`/api/`)"
           - "traefik.http.routers.api.tls.certResolver=letsencrypt"
           - "traefik.http.routers.api.middlewares=strip-api-prefix@file"

    db:
        image: mongo
        volumes:
            - db:/data/db
            # after creating db volume
            # - "./dump:/dump"
        ports:
            - 27017:27017
        restart: on-failure:5
        networks:
            - traefik

networks:
    traefik:
        external: true

volumes:
    db:
